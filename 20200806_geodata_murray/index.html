<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Map Basics</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>

</head>

<body>

  <div id="chart"></div>

  <style>

  </style>

  <script type="text/javascript">

    var h = 800;
    var w = 1000;

    var svg = d3.select("#chart").append("svg")
      .attr("viewbox", "0 0 " + w + h)
      .attr("preserveAspectRatio", "xMinYMin meet")
      .attr("height", h)
      .attr("width", w);



    var projection = d3.geoAlbersUsa();

    var path = d3.geoPath()
      .projection(d3.geoAlbersUsa());

    var color = d3.scaleQuantize()
      .range(["#eff3ff","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#084594"]);

    d3.csv("us-ag-productivity.csv").then(data => {
      color.domain([
        d3.min(data, d => d.value),
        d3.max(data, d => d.value)
      ]);

      d3.json("us-states.json").then(json => {

        // Merge agriculture data and GeoJSON
        for (var i = 0; i < data.length; i++) {
          // Grab state name
          var dataState = data[i].state;
          // Grab data value
          var dataValue = parseFloat(data[i]. value);
          // Find corresponding state in the GeoJSON
          for (var j = 0; j < json.features.length; j++) {
            var jsonState = json.features[j].properties.name;
            if (dataState == jsonState) {
              // Copy data value into json
              json.features[j].properties.value = dataValue;
              break;
            }
          }
        }

        // Bind data, create one path per GeoJSON feature
        svg.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
          .style("fill", d => {
            var value = d.properties.value;

            if (value) {
              return color(value);
            } else {
              return "#ccc";
            }
          });

        d3.csv("us-cities.csv").then(data => {
          svg.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", d => projection([d.lon, d.lat])[0])
            .attr("cy", d => projection([d.lon, d.lat])[1])
            .attr("r", 6)
            .style("fill", "yellow")
            .style("stroke", "gray")
            .style("opacity", 0.75)
            .append("title")
              .text(d => d.place);
        });
      });
    });



  </script>
</body>
</html>
